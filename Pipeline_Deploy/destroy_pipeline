pipeline {
    agent any
    environment {
        GITHUB_URL = 'https://github.com/gibeom01/final_project.git'
        TF_DIR = 'AWS_GCP_terraform'
        PATH = "/opt/homebrew/bin:$PATH"
    }
    stages {
        stage('Checkout Code') {
            steps {
                checkout scmGit(branches: [[name: '*/main']],
                    userRemoteConfigs: [[url: "${GITHUB_URL}"]])
            }
        }

        stage('Verify Terraform') {
            steps {
                sh 'which terraform'
            }
        }

        stage('Terraform Init and Plan') {
            steps {
                dir("${TF_DIR}") {
                    sh """
                        terraform init
                        terraform plan -out=plan.out
                    """
                }
            }
        }

        stage('Check Resources in Terraform State') {
            steps {
                dir("${TF_DIR}") {
                    script {
                        def resources = sh(script: 'terraform state list', returnStdout: true).trim()
                        if (resources == "") {
                            echo "No resources found. Proceeding to apply new resources."
                        } else {
                            echo "Resources found: \n${resources}"
                        }
                    }
                }
            }
        }

        stage('Terraform Apply and Destroy') {
            steps {
                dir("${TF_DIR}") {
                    script {
                        // 리소스가 없으면 새로 생성
                        if (sh(script: 'terraform state list', returnStdout: true).trim() == "") {
                            sh 'terraform apply -auto-approve plan.out'
                        } else {
                            sh 'terraform destroy -auto-approve'
                        }
                    }
                }
            }
        }
    }
}
